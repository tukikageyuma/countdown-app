<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>日時カウントダウン</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#60a5fa;--muted:#94a3b8;--glass:rgba(255,255,255,0.02)}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN',Meiryo,Arial;background:linear-gradient(180deg,#071026 0%,#071a2b 60%);color:#e6eef8;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .wrap{width:100%;max-width:820px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:18px;border-radius:12px;box-shadow:0 6px 24px rgba(2,6,23,0.6);}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:14px}
    @media(max-width:820px){.grid{grid-template-columns:1fr} .right{order:2}}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:8px}
    input,button,select{width:100%;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:15px}
    .controls{display:flex;gap:8px}
    .controls button{flex:1}
    .count{display:flex;gap:10px;justify-content:center;align-items:center;font-weight:700}
    .part{text-align:center;padding:12px;border-radius:10px;background:var(--glass);min-width:70px}
    .small{font-size:12px;color:var(--muted);font-weight:500}
    footer{margin-top:12px;font-size:13px;color:var(--muted)}
    .actions{display:flex;gap:8px;margin-top:8px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>日時カウントダウン</h1>
      <div class="pill">シングルファイル — ブラウザで開くだけ</div>
    </header>

    <div class="card grid">
      <section>
        <div style="margin-bottom:12px">
          <label for="title">タイトル（任意）</label>
          <input id="title" placeholder="例: 誕生日まで" />
        </div>

        <div style="margin-bottom:12px">
          <label for="target">日時を選択</label>
          <input id="target" type="datetime-local" />
        </div>

        <div style="margin-bottom:12px">
          <label for="tz">タイムゾーン（省略可）</label>
          <select id="tz"></select>
        </div>

        <div style="margin-bottom:12px">
          <label>動作</label>
          <div class="controls">
            <button id="start">開始</button>
            <button id="stop">停止</button>
          </div>
        </div>

        <div style="margin-top:8px">
          <label>共有 / 保存</label>
          <div class="actions">
            <button id="share">共有リンクを作る</button>
            <button id="save">ローカルに保存</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <label>アラーム</label>
          <div style="display:flex;gap:8px">
            <input id="alarmEnabled" type="checkbox" /> <label for="alarmEnabled" style="margin:0">到達時に音を鳴らす</label>
          </div>
        </div>

        <footer>※ ブラウザのタブを閉じると停止します。ローカル保存はブラウザの動作に依存します。</footer>
      </section>

      <aside class="right">
        <div style="display:flex;flex-direction:column;gap:10px">
          <div class="card" style="text-align:center">
            <div class="small">残り</div>
            <div id="display" style="margin-top:10px">
              <div class="count">
                <div class="part"><div id="days">0</div><div class="small">日</div></div>
                <div class="part"><div id="hours">00</div><div class="small">時間</div></div>
                <div class="part"><div id="minutes">00</div><div class="small">分</div></div>
                <div class="part"><div id="seconds">00</div><div class="small">秒</div></div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="small">プレビュー</div>
            <div id="preview" style="margin-top:8px">— 未設定 —</div>
          </div>

          <div class="card">
            <div class="small">操作ログ</div>
            <div id="log" style="margin-top:8px;max-height:160px;overflow:auto;color:var(--muted);font-size:13px">準備完了</div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // DOM
    const targetInput = document.getElementById('target');
    const titleInput = document.getElementById('title');
    const tzSelect = document.getElementById('tz');
    const startBtn = document.getElementById('start');
    const stopBtn = document.getElementById('stop');
    const shareBtn = document.getElementById('share');
    const saveBtn = document.getElementById('save');
    const alarmEnabled = document.getElementById('alarmEnabled');

    const daysEl = document.getElementById('days');
    const hoursEl = document.getElementById('hours');
    const minutesEl = document.getElementById('minutes');
    const secondsEl = document.getElementById('seconds');
    const preview = document.getElementById('preview');
    const log = document.getElementById('log');

    let intervalId = null;
    let targetTime = null; // Date object in UTC

    function logMsg(s){
      const t = new Date().toLocaleTimeString();
      log.innerText = `[${t}] ${s}\n` + log.innerText;
    }

    // populate timezones (simple list)
    const tzs = [
      'UTC','Asia/Tokyo','Asia/Shanghai','America/New_York','Europe/London','Europe/Paris','Asia/Seoul','Australia/Sydney'
    ];
    for(const t of tzs){
      const o = document.createElement('option'); o.value = t; o.innerText = t; tzSelect.appendChild(o);
    }
    // default to user's Intl timezone if available
    try{tzSelect.value = Intl.DateTimeFormat().resolvedOptions().timeZone}catch(e){}

    // helpers
    function pad(n){return String(n).padStart(2,'0')}

    function parseLocalInputToUTC(value, tz){
      // value is like '2025-09-29T20:30'
      if(!value) return null;
      // create date in local timezone of browser from input
      const local = new Date(value);
      if(tz && tz !== 'UTC' && tz !== Intl.DateTimeFormat().resolvedOptions().timeZone){
        // best-effort: use Date string with 'Z' offset adjusted using timezone offset lookup by using Intl API
        // We'll convert using Intl to format the time in the selected zone, then parse back to obtain UTC millis.
        // Create components from the local input
        const [datePart,timePart] = value.split('T');
        const [y,m,d] = datePart.split('-').map(Number);
        const [hh,mm] = timePart.split(':').map(Number);
        // Create a UTC-based date from components
        const asUTC = Date.UTC(y,m-1,d,hh,mm);
        // Now determine the offset between the named timezone and UTC at that instant by formatting with Intl
        try{
          const fmt = new Intl.DateTimeFormat('en-US',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',hour12:false});
          const parts = fmt.formatToParts(new Date(asUTC));
          // parts give the wall time in that timezone corresponding to the same instant — we need reverse mapping.
          // Simpler approach: find the timezone offset in minutes by comparing epoch of the local wall time in tz to UTC epoch.
          const tzStr = `${y}-${pad(m)}-${pad(d)} ${pad(hh)}:${pad(mm)}:00`;
          // create a Date by interpreting tzStr as if it's in that timezone is non-trivial without external libs.
          // Fallback: use the browser local timezone interpretation.
          return local;
        }catch(e){return local}
      }
      return local;
    }

    function updatePreview(){
      const t = targetInput.value;
      if(!t){ preview.innerText = '— 未設定 —'; return }
      preview.innerText = (titleInput.value || 'カウントダウン') + ' → ' + t + (tzSelect.value? (' ('+tzSelect.value+')') : '');
    }

    function tickOnce(){
      if(!targetTime) return;
      const now = new Date();
      let diff = targetTime - now;
      if(diff <= 0){
        daysEl.innerText='0'; hoursEl.innerText='00'; minutesEl.innerText='00'; secondsEl.innerText='00';
        clearInterval(intervalId); intervalId = null;
        logMsg('到達しました！');
        if(alarmEnabled.checked) playBeep();
        return;
      }
      const days = Math.floor(diff / (1000*60*60*24)); diff -= days*(1000*60*60*24);
      const hours = Math.floor(diff / (1000*60*60)); diff -= hours*(1000*60*60);
      const minutes = Math.floor(diff / (1000*60)); diff -= minutes*(1000*60);
      const seconds = Math.floor(diff/1000);
      daysEl.innerText = String(days);
      hoursEl.innerText = pad(hours);
      minutesEl.innerText = pad(minutes);
      secondsEl.innerText = pad(seconds);
    }

    function startCountdown(){
      const raw = targetInput.value;
      if(!raw){ alert('日時を指定してください'); return }
      const parsed = parseLocalInputToUTC(raw, tzSelect.value);
      if(!parsed){ alert('日時の解釈に失敗しました'); return }
      targetTime = parsed;
      // if user selected explicit timezone 'UTC'
      if(tzSelect.value === 'UTC'){
        // treat the input as UTC by adding browser offset difference
        const parts = raw.split('T');
        const [y,m,d] = parts[0].split('-').map(Number);
        const [hh,mm] = parts[1].split(':').map(Number);
        targetTime = new Date(Date.UTC(y,m-1,d,hh,mm));
      }
      updatePreview();
      if(intervalId) clearInterval(intervalId);
      tickOnce();
      intervalId = setInterval(tickOnce, 250);
      logMsg('開始: ' + preview.innerText);
      saveState();
    }

    function stopCountdown(){
      if(intervalId){ clearInterval(intervalId); intervalId = null; logMsg('停止しました'); }
    }

    startBtn.addEventListener('click', startCountdown);
    stopBtn.addEventListener('click', stopCountdown);
    targetInput.addEventListener('change', updatePreview);
    titleInput.addEventListener('input', updatePreview);
    tzSelect.addEventListener('change', updatePreview);

    // share: create URL with params
    shareBtn.addEventListener('click', ()=>{
      const t = targetInput.value; if(!t){ alert('日時を設定してください'); return }
      const params = new URLSearchParams(); params.set('t', t); if(titleInput.value) params.set('title', titleInput.value); if(tzSelect.value) params.set('tz', tzSelect.value); const url = location.origin + location.pathname + '?' + params.toString(); navigator.clipboard.writeText(url).then(()=>{ alert('共有リンクをコピーしました'); logMsg('共有リンクを作成') }).catch(()=>{ prompt('共有リンク (コピーしてください)', url) });
    });

    // save: download simple JSON
    saveBtn.addEventListener('click', ()=>{
      const data = {title:titleInput.value,target:targetInput.value,tz:tzSelect.value,alarm:alarmEnabled.checked};
      const blob = new Blob([JSON.stringify(data, null, 2)],{type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'countdown.json'; a.click(); URL.revokeObjectURL(a.href);
      logMsg('保存しました');
    });

    // basic beep using WebAudio
    function playBeep(){
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type = 'sine'; o.frequency.value = 880; g.gain.value = 0.05;
        o.connect(g); g.connect(ctx.destination); o.start();
        setTimeout(()=>{ o.stop(); ctx.close(); }, 1200);
      }catch(e){ console.warn(e); }
    }

    // persist to localStorage
    function saveState(){
      const st = {title:titleInput.value,target:targetInput.value,tz:tzSelect.value,alarm:alarmEnabled.checked};
      localStorage.setItem('countdown.v1', JSON.stringify(st));
    }
    function loadState(){
      const raw = localStorage.getItem('countdown.v1');
      if(!raw) return;
      try{
        const st = JSON.parse(raw);
        if(st.title) titleInput.value = st.title;
        if(st.target) targetInput.value = st.target;
        if(st.tz) tzSelect.value = st.tz;
        if(st.alarm) alarmEnabled.checked = st.alarm;
        updatePreview();
      }catch(e){}
    }

    // parse URL params on load
    function applyUrlParams(){
      const p = new URLSearchParams(location.search);
      if(p.has('title')) titleInput.value = p.get('title');
      if(p.has('t')) targetInput.value = p.get('t');
      if(p.has('tz')) tzSelect.value = p.get('tz');
      updatePreview();
    }

    // keyboard: space toggles start/stop
    window.addEventListener('keydown', (e)=>{
      if(e.code === 'Space'){
        e.preventDefault(); if(intervalId) stopCountdown(); else startCountdown();
      }
    });

    // init
    loadState(); applyUrlParams();
    logMsg('アプリ準備完了');
  </script>
</body>
</html>
